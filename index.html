<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Criador de Gráfico de Pirâmide Personalizável</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        transition: background-color 0.3s;
        background-color: #f0f0f0; 
    }
    .app-container {
        display: none; 
        max-width: 510px; /* MODIFICADO: Ajustado para a largura do iframe */
        margin: auto;
        padding: 15px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .top-panel {
        display: flex;
        flex-direction: column; /* MODIFICADO: Controles e formulários um sobre o outro */
        gap: 20px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    .controls {
        display: flex;
        flex-direction: column;
        width: 100%; /* MODIFICADO */
    }
    #form-container {
        width: 100%; /* MODIFICADO */
        max-height: 250px;
        overflow-y: auto;
        padding-right: 10px;
    }
    .control-group {
        margin-bottom: 15px;
    }
    .control-group label {
        display: block;
        margin-bottom: 5px;
    }
    .chart-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px;
    }
    #chart-title {
        margin-bottom: 20px;
        min-height: 28px;
        text-align: center;
    }
    #chart-description {
        margin-top: 20px;
        max-width: 100%;
        text-align: center;
        min-height: 1.2em;
        white-space: pre-wrap;
    }
    .main-container {
        display: flex;
        justify-content: center;
    }
    /* MODIFICADO: O contêiner de nomes e descrições laterais foi removido. */
    #pyramid-container {
        width: 400px;
        height: 346.41px;
        position: relative;
        margin: 0 auto; /* Garante a centralização */
    }
    .band-container {
        position: absolute;
        width: 100%;
        height: 100%;
    }
    .band {
        width: 100%;
        height: 100%;
        clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
    }
    .band-percentage {
        position: absolute;
        top: 50%;
        left: 15px;
        transform: translateY(-50%);
        font-size: 0.9em;
        font-weight: bold;
        color: white;
        text-shadow: 1px 1px 2px black;
        pointer-events: none;
    }
    .input-group {
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 5px;
    }
    .color-picker-group {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-top: 8px;
    }
    .color-control {
       width: 48%;
    }
    /* --- NOVOS ESTILOS PARA A LEGENDA --- */
    #details-container {
        width: 100%;
        max-width: 450px; 
        margin-top: 25px;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    .detail-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 8px;
        border: 1px solid #eee;
        border-radius: 4px;
    }
    .detail-color-swatch {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        margin-top: 2px;
        border: 1px solid #ccc;
    }
    .detail-text-content {
        display: flex;
        flex-direction: column;
        width: 100%;
    }
    .detail-name {
        font-weight: bold;
        margin-bottom: 4px;
        word-wrap: break-word;
    }
    .detail-description {
        font-size: 0.9em;
        color: #555;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    /* --- FIM DOS NOVOS ESTILOS --- */

    #export-btn {
        margin-top: 10px;
        padding: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 5px;
        font-weight: bold;
    }
    #export-btn:hover {
        background-color: #218838;
    }
    .hidden {
        display: none;
    }
</style>
</head>
<body>

<div class="app-container" id="app-container">
    <div class="top-panel">
        <div class="controls">
            <!-- Os controles permanecem os mesmos -->
            <div class="control-group">
                <label for="chart-title-input">Título do Gráfico:</label>
                <input type="text" id="chart-title-input">
                <label for="title-color-input">Cor:</label>
                <input type="color" id="title-color-input" value="#000000">
            </div>
            <div class="control-group">
                <label for="chart-description-input">Descrição Geral do Gráfico:</label>
                <textarea id="chart-description-input" rows="3"></textarea>
                <label for="desc-color-input">Cor:</label>
                <input type="color" id="desc-color-input" value="#333333">
            </div>
            <div class="control-group">
                <label for="percentage-color-input">Cor das Porcentagens:</label>
                <input type="color" id="percentage-color-input" value="#FFFFFF">
            </div>
            <div class="control-group">
                <label for="bg-color-input">Cor do Fundo do Gráfico:</label>
                <input type="color" id="bg-color-input" value="#FFFFFF">
            </div>
            <div class="control-group">
                <label for="bands">Número de Faixas:</label>
                <input type="number" id="bands" min="1" value="5">
            </div>
            <div class="control-group">
                <label for="show-percentage-input" style="display: inline-flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="show-percentage-input" checked> Exibir Porcentagens
                </label>
            </div>
            <button onclick="createPyramid()">Criar/Atualizar Pirâmide</button>
            <button id="export-btn" onclick="exportChartAsImage()">Exportar como Imagem</button>
        </div>
        <div id="form-container"></div>
    </div>
    
    <div class="chart-area" id="chart-to-export">
        <h2 id="chart-title"></h2>
        <div class="main-container">
            <!-- MODIFICADO: Apenas a pirâmide fica aqui agora -->
            <div id="pyramid-container"></div>
        </div>
        <!-- MODIFICADO: Novo contêiner para os detalhes das faixas -->
        <div id="details-container"></div>
        <p id="chart-description"></p>
    </div>
</div>


<script>
    // --- LÓGICA DE SEGURANÇA ---
    const allowedOrigin = "https://omniholopanto.blogspot.com";
    const appContainer = document.getElementById('app-container');

    window.addEventListener("message", (event) => {
        if (event.origin !== allowedOrigin) {
            console.warn("Mensagem recebida de uma origem não permitida:", event.origin);
            return;
        }
        if (event.data === "showPyramidTool") {
            console.log("Acesso autorizado. Exibindo a ferramenta.");
            appContainer.style.display = 'block';
            initialize(); 
        }
    }, false);


    // --- ELEMENTOS DE CONTROLE ---
    const titleInput = document.getElementById('chart-title-input');
    const titleColorInput = document.getElementById('title-color-input');
    const descriptionInput = document.getElementById('chart-description-input');
    const descColorInput = document.getElementById('desc-color-input');
    const percentageColorInput = document.getElementById('percentage-color-input');
    const bgColorInput = document.getElementById('bg-color-input');
    const chartTitle = document.getElementById('chart-title');
    const chartDescription = document.getElementById('chart-description');
    const chartArea = document.getElementById('chart-to-export');
    const showPercentageInput = document.getElementById('show-percentage-input');

    // MODIFICADO: Função createPyramid foi significativamente alterada
    function createPyramid() {
        const numBands = parseInt(document.getElementById('bands').value);
        const pyramidContainer = document.getElementById('pyramid-container');
        const detailsContainer = document.getElementById('details-container'); // O novo container da legenda
        const formContainer = document.getElementById('form-container');
        const containerWidth = 400;
        const containerHeight = 346.41;
        const totalArea = (containerWidth * containerHeight) / 2;

        // Limpa os containers antigos
        pyramidContainer.innerHTML = '';
        detailsContainer.innerHTML = '';
        formContainer.innerHTML = '';

        const bandHeight = containerHeight / numBands;

        for (let i = 0; i < numBands; i++) {
            // --- CRIAÇÃO DA FAIXA DA PIRÂMIDE (sem alterações aqui) ---
            const bandContainer = document.createElement('div');
            bandContainer.classList.add('band-container');
            const topY = i * bandHeight;
            const topWidth = (topY / containerHeight) * containerWidth;
            const bottomY = (i + 1) * bandHeight;
            const bottomWidth = (bottomY / containerHeight) * containerWidth;
            const bandArea = ((topWidth + bottomWidth) / 2) * bandHeight;
            const percentage = (bandArea / totalArea) * 100;
            const bandColor = `hsl(${i * (360 / numBands)}, 70%, 50%)`;

            bandContainer.style.top = `${topY}px`;
            bandContainer.style.left = `${(containerWidth - bottomWidth) / 2}px`;
            bandContainer.style.width = `${bottomWidth}px`;
            bandContainer.style.height = `${bandHeight}px`;

            const band = document.createElement('div');
            band.classList.add('band');
            band.style.backgroundColor = bandColor;
            band.style.clipPath = `polygon(${((bottomWidth - topWidth) / 2) / bottomWidth * 100}% 0, ${100 - (((bottomWidth - topWidth) / 2) / bottomWidth * 100)}% 0, 100% 100%, 0% 100%)`;
            
            const bandPercentage = document.createElement('div');
            bandPercentage.classList.add('band-percentage');
            bandPercentage.textContent = `${percentage.toFixed(1)}%`;
            bandPercentage.style.color = percentageColorInput.value;
            if (!showPercentageInput.checked) {
                bandPercentage.classList.add('hidden');
            }

            bandContainer.appendChild(band);
            bandContainer.appendChild(bandPercentage);
            pyramidContainer.appendChild(bandContainer);

            // --- CRIAÇÃO DO ITEM DE LEGENDA (NOVA LÓGICA) ---
            const detailItem = document.createElement('div');
            detailItem.className = 'detail-item';

            const colorSwatch = document.createElement('div');
            colorSwatch.className = 'detail-color-swatch';
            colorSwatch.style.backgroundColor = bandColor;

            const textContent = document.createElement('div');
            textContent.className = 'detail-text-content';

            const detailName = document.createElement('div');
            detailName.className = 'detail-name';
            detailName.id = `detail-name-${i}`;

            const detailDescription = document.createElement('div');
            detailDescription.className = 'detail-description';
            detailDescription.id = `detail-desc-${i}`;

            textContent.appendChild(detailName);
            textContent.appendChild(detailDescription);
            detailItem.appendChild(colorSwatch);
            detailItem.appendChild(textContent);
            detailsContainer.appendChild(detailItem);

            // --- CRIAÇÃO DO FORMULÁRIO DE INPUT (com IDs atualizados) ---
            const inputGroup = document.createElement('div');
            inputGroup.classList.add('input-group');

            const nameLabel = document.createElement('label');
            nameLabel.textContent = `Nome da Faixa ${i + 1}:`;
            const nameInput = document.createElement('input');
            nameInput.type = 'text';
            nameInput.oninput = () => { document.getElementById(`detail-name-${i}`).textContent = nameInput.value; };

            const descLabel = document.createElement('label');
            descLabel.textContent = `Descrição da Faixa ${i + 1}:`;
            const descInput = document.createElement('textarea');
            descInput.rows = 2; // Menor para caber mais
            descInput.oninput = () => { document.getElementById(`detail-desc-${i}`).textContent = descInput.value; };

            const colorPickerGroup = document.createElement('div');
            colorPickerGroup.classList.add('color-picker-group');
            
            const nameColorControl = document.createElement('div');
            nameColorControl.classList.add('color-control');
            const nameColorLabel = document.createElement('label');
            nameColorLabel.textContent = 'Cor Nome:';
            const nameColorInput = document.createElement('input');
            nameColorInput.type = 'color';
            nameColorInput.value = '#000000';
            nameColorInput.title = 'Cor do nome da faixa';
            nameColorInput.oninput = () => { document.getElementById(`detail-name-${i}`).style.color = nameColorInput.value; };
            nameColorControl.appendChild(nameColorLabel);
            nameColorControl.appendChild(nameColorInput);

            const descColorControl = document.createElement('div');
            descColorControl.classList.add('color-control');
            const descColorLabel = document.createElement('label');
            descColorLabel.textContent = 'Cor Desc.:';
            const bandDescColorInput = document.createElement('input');
            bandDescColorInput.type = 'color';
            bandDescColorInput.value = '#555555'; // Cor padrão da descrição
            bandDescColorInput.title = 'Cor da descrição da faixa';
            bandDescColorInput.oninput = () => { document.getElementById(`detail-desc-${i}`).style.color = bandDescColorInput.value; };
            descColorControl.appendChild(descColorLabel);
            descColorControl.appendChild(bandDescColorInput);
            
            colorPickerGroup.appendChild(nameColorControl);
            colorPickerGroup.appendChild(descColorControl);

            inputGroup.appendChild(nameLabel);
            inputGroup.appendChild(nameInput);
            inputGroup.appendChild(descLabel);
            inputGroup.appendChild(descInput);
            inputGroup.appendChild(colorPickerGroup);
            formContainer.appendChild(inputGroup);
            
            // Define as cores iniciais
            document.getElementById(`detail-name-${i}`).style.color = nameColorInput.value;
            document.getElementById(`detail-desc-${i}`).style.color = bandDescColorInput.value;
        }
    }

    function exportChartAsImage() {
        const chartElement = document.getElementById('chart-to-export');
        
        html2canvas(chartElement, {
            backgroundColor: chartElement.style.backgroundColor || '#FFFFFF',
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            const filename = (chartTitle.textContent.trim().replace(/\s+/g, '_') || 'grafico_piramide') + '.png';
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    function togglePercentages() {
        document.querySelectorAll('.band-percentage').forEach(el => {
            el.classList.toggle('hidden', !showPercentageInput.checked);
        });
    }

    // --- EVENT LISTENERS GLOBAIS ---
    titleInput.oninput = () => { chartTitle.textContent = titleInput.value; };
    titleColorInput.oninput = () => { chartTitle.style.color = titleColorInput.value; };
    descriptionInput.oninput = () => { chartDescription.textContent = descriptionInput.value; };
    descColorInput.oninput = () => { chartDescription.style.color = descColorInput.value; };
    bgColorInput.oninput = () => { chartArea.style.backgroundColor = bgColorInput.value; };
    percentageColorInput.oninput = () => {
        document.querySelectorAll('.band-percentage').forEach(el => el.style.color = percentageColorInput.value);
    };
    showPercentageInput.onchange = togglePercentages;

    // --- INICIALIZAÇÃO ---
    function initialize() {
        titleInput.value = "Título do Gráfico";
        chartTitle.textContent = titleInput.value;
        chartTitle.style.color = titleColorInput.value;

        descriptionInput.value = "Descrição geral e detalhada do gráfico.";
        chartDescription.textContent = descriptionInput.value;
        chartDescription.style.color = descColorInput.value;
        
        chartArea.style.backgroundColor = bgColorInput.value;

        createPyramid();
    }
</script>

</body>
</html>
